<launch>
  <!-- ========================================================= -->
  <!--  Base TurtleBot bringup (kobuki, diagnostics, cmd_vel_mux) -->
  <!-- ========================================================= -->
  <!-- This assumes the standard TurtleBot bringup is installed -->
  <include file="$(find turtlebot_bringup)/launch/minimal.launch" />

  <!-- ========================================================= -->
  <!--  3D sensor (Astra via OpenNI2-style launch)               -->
  <!-- ========================================================= -->
  <!-- Use the standard OpenNI2 camera launch to get /camera/* topics -->
  <include file="$(find openni2_launch)/launch/openni2.launch" />

  <!-- Depth image -> LaserScan on /scan so nav stack can use it -->
  <node pkg="depthimage_to_laserscan"
        type="depthimage_to_laserscan"
        name="depthimage_to_laserscan_node"
        output="screen">
    <remap from="image" to="/camera/depth/image_raw" />
    <remap from="scan"  to="/scan" />
    <param name="output_frame_id" value="camera_depth_frame" />
    <param name="range_min"       value="0.45" />
    <param name="scan_height"     value="10" />
  </node>

  <!-- ========================================================= -->
  <!--  Map + Localization                                       -->
  <!-- ========================================================= -->

  <!-- Static map of B4 basement -->
  <node pkg="map_server"
        type="map_server"
        name="map_server"
        args="$(find tour_guide)/maps/basement_b4.yaml"
        output="screen">
    <param name="frame_id" value="map" />
  </node>

  <!-- AMCL localization -->
  <node pkg="amcl"
        type="amcl"
        name="amcl"
        output="screen">
    <param name="use_map_topic"   value="true" />
    <param name="odom_frame_id"   value="odom" />
    <param name="base_frame_id"   value="base_link" />
    <param name="global_frame_id" value="map" />

    <!-- You were already using these kinds of params; keep defaults
         unless you need to tune. Iâ€™m only setting the key frame ones. -->
  </node>

  <!-- ========================================================= -->
  <!--  Navigation: move_base + costmaps                         -->
  <!-- ========================================================= -->

  <node pkg="move_base"
        type="move_base"
        name="move_base"
        output="screen">

    <!-- *** CRITICAL FIX ***: send nav velocities to the base topic -->
    <remap from="cmd_vel" to="/mobile_base/commands/velocity" />

    <!-- Costmap params (use the YAMLs you already have) -->
    <rosparam file="$(find tour_guide)/config/costmap_common_params.yaml"
              command="load"
              ns="global_costmap" />
    <rosparam file="$(find tour_guide)/config/costmap_common_params.yaml"
              command="load"
              ns="local_costmap" />

    <rosparam file="$(find tour_guide)/config/global_costmap_params.yaml"
              command="load" />
    <rosparam file="$(find tour_guide)/config/local_costmap_params.yaml"
              command="load" />

    <param name="base_global_planner" value="navfn/NavfnROS" />
    <param name="base_local_planner"  value="dwa_local_planner/DWAPlannerROS" />
  </node>

  <!-- ========================================================= -->
  <!--  Tour guide logic                                         -->
  <!-- ========================================================= -->

  <!-- 1) Goal runner: sends forward + return goals -->
  <node pkg="tour_guide"
        type="goal_runner.py"
        name="goal_runner"
        output="screen">
    <param name="frame_id" value="map" />

    <!-- TODO: replace these with real coordinates from /amcl_pose -->
    <rosparam param="forward_goal_xy">[2.0, -1.0]</rosparam>
    <param    name="forward_goal_yaw" value="0.0" />

    <rosparam param="return_goal_xy">[0.0, 0.0]</rosparam>
    <param    name="return_goal_yaw" value="3.14" />
  </node>

  <!-- 2) Checkerboard IR detector: asks for help at door -->
  <node pkg="tour_guide"
        type="checkerboard_ir.py"
        name="checkerboard_ir"
        output="screen">
    <param name="image_topic" value="/camera/ir/image" />
    <param name="pattern_rows" value="7" />
    <param name="pattern_cols" value="5" />

    <param name="global_frame" value="map" />
    <param name="base_frame"   value="base_link" />

    <!-- TODO: set this from /amcl_pose when the robot is at the door -->
    <rosparam param="door_center_xy">[0.0, 0.0]</rosparam>
    <param    name="door_radius_m"      value="1.5" />
    <param    name="door_beep_value"    value="3" />
    <param    name="announce_cooldown_sec" value="5.0" />
  </node>

  <!-- 3) Help watchdog: asks for help when stuck / no plan -->
  <node pkg="tour_guide"
        type="help_watchdog.py"
        name="help_watchdog"
        output="screen">
    <param name="global_frame" value="map" />
    <param name="base_frame"   value="base_link" />

    <param name="help_beep_value"       value="4" />
    <param name="no_plan_threshold_sec" value="8.0" />
    <param name="plan_check_period"     value="1.0" />
  </node>

</launch>
